[
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Sales Invoice",
  "enabled": 1,
  "modified": "2025-10-08 11:20:14.413567",
  "module": "FBR Integration",
  "name": "Sales Tax Calculations",
  "script": "frappe.ui.form.on('Sales Invoice Item', {\r\n    qty: calculate_tax_fields,\r\n    rate: calculate_tax_fields,\r\n    custom_sales_tax_rate: calculate_tax_fields,\r\n    custom_further_tax_rate: calculate_tax_fields,\r\n    custom_extra_tax_rate: calculate_tax_fields,\r\n    item_tax_template: function (frm, cdt, cdn) {\r\n        let row = locals[cdt][cdn];\r\n\r\n        if (row.item_tax_template) {\r\n            frappe.db.get_doc(\"Item Tax Template\", row.item_tax_template).then(doc => {\r\n                // Reset before applying\r\n                row.custom_sales_tax_rate = 0;\r\n                row.custom_further_tax_rate = 0;\r\n                row.custom_extra_tax_rate = 0;\r\n\r\n                // Map tax rates to your custom fields\r\n                (doc.taxes || []).forEach(tax => {\r\n                    if (tax.tax_type.includes(\"Sales Tax\")) {\r\n                        row.custom_sales_tax_rate = tax.tax_rate;\r\n                    } else if (tax.tax_type.includes(\"Further Tax\")) {\r\n                        row.custom_further_tax_rate = tax.tax_rate;\r\n                    } else if (tax.tax_type.includes(\"Extra Tax\")) {\r\n                        row.custom_extra_tax_rate = tax.tax_rate;\r\n                    }\r\n                });\r\n\r\n                calculate_tax_fields(frm, cdt, cdn); // Recalculate with updated rates\r\n                frm.refresh_field(\"items\");\r\n            });\r\n        } else {\r\n            // If no template, keep manual entry as-is\r\n            calculate_tax_fields(frm, cdt, cdn);\r\n        }\r\n    }\r\n});\r\n\r\nfunction calculate_tax_fields(frm, cdt, cdn) {\r\n    let row = locals[cdt][cdn];\r\n\r\n    let qty = parseFloat(row.qty) || 0;\r\n    let rate = parseFloat(row.rate) || 0;\r\n    let amount = qty * rate;\r\n    row.amount = amount;\r\n\r\n    // Reset values\r\n    row.custom_sales_tax = 0;\r\n    row.custom_further_tax = 0;\r\n    row.custom_extra_tax = 0;\r\n    row.custom_total_tax_amount = 0;\r\n    row.custom_tax_inclusive_amount = amount;\r\n\r\n    if (amount) {\r\n        if (row.custom_sales_tax_rate) {\r\n            row.custom_sales_tax = (amount * row.custom_sales_tax_rate) / 100;\r\n            row.custom_tax_inclusive_amount += row.custom_sales_tax;\r\n        }\r\n        if (row.custom_further_tax_rate) {\r\n            row.custom_further_tax = (amount * row.custom_further_tax_rate) / 100;\r\n            row.custom_tax_inclusive_amount += row.custom_further_tax;\r\n        }\r\n        if (row.custom_extra_tax_rate) {\r\n            row.custom_extra_tax = (amount * row.custom_extra_tax_rate) / 100;\r\n            row.custom_tax_inclusive_amount += row.custom_extra_tax;\r\n        }\r\n\r\n        row.custom_total_tax_amount =\r\n            row.custom_sales_tax +\r\n            row.custom_further_tax +\r\n            row.custom_extra_tax;\r\n    }\r\n\r\n    frm.refresh_field(\"items\");\r\n}\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Sales Invoice",
  "enabled": 1,
  "modified": "2025-10-08 20:45:26.557100",
  "module": "FBR Integration",
  "name": "Send to FBR Button",
  "script": "frappe.ui.form.on(\"Sales Invoice\", {\r\n    refresh: function (frm) {\r\n        if (frm.doc.docstatus !== 1) return;\r\n\r\n        // Custom gradient button with animation\r\n        let btn = frm.add_custom_button(\r\n            __(\"Send üöÄ FBR\"),\r\n            function () {\r\n                if (frm.doc.custom_fbr_invoice_no) {\r\n                    // Already sent\r\n                    frappe.msgprint({\r\n                        title: __(\"Already Submitted\"),\r\n                        indicator: \"red\",\r\n                        message: `\r\n                            <div style=\"\r\n                                background: #fff3f3;\r\n                                border-left: 6px solid #ff4d4d;\r\n                                padding: 14px 16px;\r\n                                border-radius: 8px;\r\n                                font-size: 14px;\r\n                                line-height: 1.6;\r\n                            \">\r\n                                <p>üö´ <b>Invoice already sent to IRIS‚ÄìFBR Portal</b></p>\r\n                                <p>Your FBR Invoice No.: <b style=\"color:#b30000;\">${frm.doc.custom_fbr_invoice_no}</b></p>\r\n                                <p style=\"color:green; margin-top:8px;\">\r\n                                    üìû For assistance, contact <b>Fibersoft ERP Pakistan</b> at <b>0300-3360042</b>\r\n                                </p>\r\n                            </div>\r\n                        `\r\n                    });\r\n                    return;\r\n                }\r\n\r\n                frappe.confirm(\r\n                    __(\"Are you sure you want to send this invoice to FBR?\"),\r\n                    () => {\r\n                        frappe.show_alert({\r\n                            message: __(\"üì° Sending invoice to FBR...\"),\r\n                            indicator: \"orange\"\r\n                        });\r\n\r\n                        frappe.call({\r\n                            method: \"fbr_integration.handler.send_to_fbr_si\",\r\n                            args: { name: frm.doc.name },\r\n                            freeze: true,\r\n                            freeze_message: __(\"üîÑ Please wait, communicating with IRIS‚ÄìFBR Portal...\"),\r\n                            callback: function (r) {\r\n                                if (!r || !r.message) {\r\n                                    frappe.msgprint({\r\n                                        title: __(\"Error\"),\r\n                                        indicator: \"red\",\r\n                                        message: __(\"No response from server.\")\r\n                                    });\r\n                                    return;\r\n                                }\r\n\r\n                                const resp = r.message;\r\n                                if (resp.success === false) {\r\n                                    frappe.msgprint({\r\n                                        title: __(\"FBR Submission Failed\"),\r\n                                        indicator: \"red\",\r\n                                        message: `\r\n                                            <div style=\"\r\n                                                background: #fff4e6;\r\n                                                border-left: 6px solid #ff9933;\r\n                                                padding: 14px 16px;\r\n                                                border-radius: 8px;\r\n                                                font-size: 14px;\r\n                                                line-height: 1.6;\r\n                                            \">\r\n                                                <p>‚ùå <b>Error while sending invoice to FBR</b></p>\r\n                                                <pre style=\"background:#f9f9f9; padding:8px; border-radius:6px;\">${resp.error}</pre>\r\n                                            </div>\r\n                                        `\r\n                                    });\r\n                                } else {\r\n                                    frappe.msgprint({\r\n                                        title: __(\"üéâ Invoice Successfully Sent\"),\r\n                                        indicator: \"green\",\r\n                                        message: `\r\n                                            <div style=\"\r\n                                                background: #e8fff1;\r\n                                                border-left: 6px solid #28a745;\r\n                                                padding: 14px 16px;\r\n                                                border-radius: 8px;\r\n                                                font-size: 14px;\r\n                                                line-height: 1.6;\r\n                                            \">\r\n                                                <p>üü¢ <b>Invoice Sent to IRIS‚ÄìFBR Portal</b></p>\r\n                                                <p><b>Invoice:</b> ${frm.doc.name}</p>\r\n                                                <p><b>FBR Invoice No:</b> <span style=\"color:#007bff;\">${resp.invoice_no}</span></p>\r\n                                                <p>‚úÖ Thank you for staying compliant and digital with Fibersoft ERP Pakistan.</p>\r\n                                            </div>\r\n                                        `\r\n                                    });\r\n\r\n                                    frappe.show_alert({\r\n                                        message: __(\"‚úÖ Successfully sent to FBR!\"),\r\n                                        indicator: \"green\"\r\n                                    });\r\n\r\n                                    frm.reload_doc();\r\n                                }\r\n                            }\r\n                        });\r\n                    }\r\n                );\r\n            }\r\n        );\r\n\r\n        // Enhanced gradient button style\r\n        btn.removeClass(\"btn-default\")\r\n            .addClass(\"btn-primary\")\r\n            .css({\r\n                background: \"linear-gradient(90deg, #e63946, #ff6f61)\",\r\n                border: \"none\",\r\n                color: \"#fff\",\r\n                fontWeight: \"600\",\r\n                borderRadius: \"8px\",\r\n                padding: \"8px 16px\",\r\n                boxShadow: \"0 3px 8px rgba(230, 57, 70, 0.4)\",\r\n                transition: \"0.3s ease-in-out\"\r\n            })\r\n            .hover(\r\n                function () {\r\n                    $(this).css({\r\n                        transform: \"scale(1.05)\",\r\n                        boxShadow: \"0 4px 12px rgba(230, 57, 70, 0.6)\"\r\n                    });\r\n                },\r\n                function () {\r\n                    $(this).css({\r\n                        transform: \"scale(1)\",\r\n                        boxShadow: \"0 3px 8px rgba(230, 57, 70, 0.4)\"\r\n                    });\r\n                }\r\n            );\r\n    }\r\n});\r\n",
  "view": "Form"
 }
]